<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‹¤ì¤‘ ì•½í’ˆ ì´ë¯¸ì§€ ë¶„ì„ê¸° (Gemini Vision)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'gemini-blue': '#4285F4',
                        'gemini-green': '#34A853',
                        'gemini-yellow': '#F4B400',
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        /* ë¡œë”© ìŠ¤í”¼ë„ˆ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4285F4;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8 flex justify-center">
    <div class="w-full max-w-4xl bg-white shadow-2xl rounded-xl p-6 md:p-10 border border-gray-100">
        <header class="mb-8 border-b pb-4">
            <h1 class="text-3xl font-extrabold text-gray-800">
                ğŸ’Š ë‹¤ì¤‘ ì•½í’ˆ ì´ë¯¸ì§€ ë¶„ì„ê¸° 
            </h1>
            <p class="text-gray-500 mt-2">
                **ì—¬ëŸ¬ ì•½í’ˆ ì´ë¯¸ì§€**ë¥¼ í•œ ë²ˆì— ì—…ë¡œë“œí•˜ì—¬ ê°œë³„ ì •ë³´ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤.
            </p>
        </header>

        <!-- 1. ì´ë¯¸ì§€ ì—…ë¡œë“œ ì„¹ì…˜ -->
        <div class="space-y-6 mb-8">
            <div class="p-5 border-2 border-dashed border-gemini-blue rounded-lg bg-blue-50">
                <label for="imageUpload" class="block text-lg font-semibold text-gray-700 mb-2 cursor-pointer">
                    ì•½í’ˆ ì´ë¯¸ì§€ ì„ íƒ (ì—¬ëŸ¬ íŒŒì¼ ì„ íƒ ê°€ëŠ¥)
                </label>
                <!-- 'multiple' ì†ì„± ì¶”ê°€ -->
                <input type="file" id="imageUpload" accept="image/*" multiple
                       class="w-full text-gray-900 cursor-pointer file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-gemini-blue file:text-white hover:file:bg-blue-700 transition duration-150">
            </div>

            <!-- ë‹¤ì¤‘ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ì»¨í…Œì´ë„ˆ -->
            <div id="imagePreviewContainer" class="hidden grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 p-4 bg-gray-100 rounded-lg">
                <!-- ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>

            <button id="analyzeButton" onclick="analyzeImages()" disabled
                    class="w-full py-3 px-4 bg-gemini-green text-white font-bold rounded-lg shadow-md hover:bg-green-600 transition duration-150 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center">
                <span id="buttonText">ì„ íƒëœ ì•½í’ˆ ì •ë³´ ì¼ê´„ ë¶„ì„ ì‹œì‘</span>
                <div id="loadingSpinner" class="spinner ml-3 hidden"></div>
            </button>

            <div id="statusMessage" class="hidden p-3 rounded-lg text-sm font-medium text-center border"></div>
        </div>

        <!-- 2. ë¶„ì„ ê²°ê³¼ ì„¹ì…˜ -->
        <div id="resultsSection" class="mt-10 pt-6 border-t border-gray-200">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">âœ¨ ì „ì²´ ë¶„ì„ ê²°ê³¼</h2>
            <div id="resultContent" class="space-y-6">
                <p class="p-6 bg-white border border-gray-200 rounded-lg shadow-inner text-gray-500 min-h-[100px]">
                    ì—¬ê¸°ì— ì—…ë¡œë“œëœ ê° ì•½í’ˆë³„ ë¶„ì„ ì •ë³´ê°€ ìˆœì°¨ì ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.
                </p>
            </div>
        </div>
    </div>

    <script>
        const imageUpload = document.getElementById('imageUpload');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const analyzeButton = document.getElementById('analyzeButton');
        const buttonText = document.getElementById('buttonText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const resultContent = document.getElementById('resultContent');
        const statusMessage = document.getElementById('statusMessage');

        const API_MODEL = 'gemini-2.5-flash-preview-09-2025';
        const apiKey = ""; 

        // ë‹¤ì¤‘ íŒŒì¼ ë°ì´í„°ë¥¼ ì €ì¥í•  ë°°ì—´
        let imageFiles = [];

        /**
         * ìƒíƒœ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•˜ê³  ìŠ¤íƒ€ì¼ì„ ì„¤ì •í•©ë‹ˆë‹¤.
         */
        function showStatus(message, type = 'info') {
            let bgColor, textColor, borderColor;
            
            switch (type) {
                case 'error':
                    bgColor = 'bg-red-100';
                    textColor = 'text-red-800';
                    borderColor = 'border-red-200';
                    break;
                case 'success':
                    bgColor = 'bg-green-100';
                    textColor = 'text-green-800';
                    borderColor = 'border-green-200';
                    break;
                case 'warning':
                    bgColor = 'bg-yellow-100';
                    textColor = 'text-yellow-800';
                    borderColor = 'border-yellow-200';
                    break;
                case 'info':
                default:
                    bgColor = 'bg-blue-100';
                    textColor = 'text-blue-800';
                    borderColor = 'border-blue-200';
                    break;
            }

            statusMessage.className = `p-3 rounded-lg text-sm font-medium text-center border ${bgColor} ${textColor} ${borderColor}`;
            statusMessage.innerHTML = message;
            statusMessage.classList.remove('hidden');
        }

        /**
         * ì„ íƒëœ ëª¨ë“  íŒŒì¼ì˜ ë¯¸ë¦¬ë³´ê¸°ë¥¼ ìƒì„±í•˜ê³  Base64 ë°ì´í„°ë¥¼ ì¤€ë¹„í•©ë‹ˆë‹¤.
         */
        imageUpload.addEventListener('change', function(event) {
            imageFiles = [];
            imagePreviewContainer.innerHTML = '';
            
            const files = event.target.files;
            if (files.length > 0) {
                analyzeButton.disabled = false;
                imagePreviewContainer.classList.remove('hidden');
                
                showStatus(`ì´ ${files.length}ê°œì˜ ì•½í’ˆ ì´ë¯¸ì§€ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. ë¶„ì„ì„ ì‹œì‘í•˜ì„¸ìš”.`, 'info');

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    if (!file.type.startsWith('image/')) continue; // ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì²˜ë¦¬

                    const reader = new FileReader();
                    reader.onload = (function(f) {
                        return function(e) {
                            const dataUrl = e.target.result;
                            const parts = dataUrl.split(',');
                            
                            if (parts.length > 1) {
                                const mimeType = parts[0].match(/:(.*?);/)[1];
                                const base64Data = parts[1];

                                // 1. ë°ì´í„° ì €ì¥
                                imageFiles.push({
                                    base64: base64Data,
                                    mimeType: mimeType,
                                    fileName: f.name || `ì´ë¯¸ì§€ ${imageFiles.length + 1}`
                                });
                                
                                // 2. ë¯¸ë¦¬ë³´ê¸° UI ìƒì„±
                                const previewItem = document.createElement('div');
                                previewItem.className = 'flex flex-col items-center bg-white p-2 rounded-lg shadow-md border border-gray-200';
                                previewItem.innerHTML = `
                                    <img src="${dataUrl}" alt="${f.name}" class="w-full h-24 object-contain rounded-md mb-1">
                                    <span class="text-xs text-center text-gray-600 truncate w-full">${f.name}</span>
                                `;
                                imagePreviewContainer.appendChild(previewItem);
                            }
                        };
                    })(file);
                    reader.readAsDataURL(file);
                }

            } else {
                analyzeButton.disabled = true;
                imagePreviewContainer.classList.add('hidden');
                resultContent.innerHTML = '<p class="p-6 bg-white border border-gray-200 rounded-lg shadow-inner text-gray-500 min-h-[100px]">ì—¬ê¸°ì— ì—…ë¡œë“œëœ ê° ì•½í’ˆë³„ ë¶„ì„ ì •ë³´ê°€ ìˆœì°¨ì ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</p>';
                showStatus("ë¶„ì„í•  ì´ë¯¸ì§€ë¥¼ í•œ ê°œ ì´ìƒ ì„ íƒí•´ ì£¼ì„¸ìš”.", 'info');
            }
        });

        /**
         * ì§€ìˆ˜ ë°±ì˜¤í”„ë¥¼ ì‚¬ìš©í•˜ì—¬ API í˜¸ì¶œì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
         */
        async function fetchWithExponentialBackoff(apiUrl, payload, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429 && i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    if (!response.ok) {
                        throw new Error(`API ìš”ì²­ ì‹¤íŒ¨: ${response.status} ${response.statusText}`);
                    }
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    // Log to console but not as a UI error for retries
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        /**
         * ëª¨ë“  ì´ë¯¸ì§€ì— ëŒ€í•´ ìˆœì°¨ì ìœ¼ë¡œ ë¶„ì„ì„ ìš”ì²­í•˜ê³  ê²°ê³¼ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
         */
        async function analyzeImages() {
            if (imageFiles.length === 0) {
                showStatus("ë¶„ì„í•  ì´ë¯¸ì§€ë¥¼ ë¨¼ì € ì„ íƒí•´ ì£¼ì„¸ìš”.", 'error');
                return;
            }

            // UI ìƒíƒœ ì—…ë°ì´íŠ¸: ë¡œë”© ì‹œì‘
            analyzeButton.disabled = true;
            loadingSpinner.classList.remove('hidden');
            resultContent.innerHTML = '';
            
            showStatus(`ì´ ${imageFiles.length}ê°œì˜ ì´ë¯¸ì§€ ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤...`, 'warning');
            
            for (let i = 0; i < imageFiles.length; i++) {
                const image = imageFiles[i];
                const imageTitle = image.fileName;
                
                // ê°œë³„ ê²°ê³¼ í‘œì‹œë¥¼ ìœ„í•œ ì¹´ë“œ ìƒì„± ë° ì´ˆê¸°í™”
                const cardId = `result-card-${i}`;
                const resultCard = document.createElement('div');
                resultCard.id = cardId;
                resultCard.className = 'p-6 bg-white border border-gemini-blue rounded-lg shadow-xl animate-pulse';
                resultCard.innerHTML = `<h3 class="text-xl font-bold text-gemini-blue mb-2">ğŸ’Š ${i + 1}. ${imageTitle}</h3>
                                        <p class="text-gray-500">... ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</p>`;
                resultContent.appendChild(resultCard);
                
                buttonText.textContent = `(${i + 1}/${imageFiles.length}) ë¶„ì„ ì¤‘: ${imageTitle}`;
                
                try {
                    const userPrompt = "ì´ ì´ë¯¸ì§€ëŠ” ì•½í’ˆ ë˜ëŠ” ì•½í’ˆ í¬ì¥ì¬ì…ë‹ˆë‹¤. ì´ë¯¸ì§€ì— ë³´ì´ëŠ” ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì•½í’ˆì˜ ì´ë¦„, ì£¼ìš” ì„±ë¶„, íš¨ëŠ¥/íš¨ê³¼, ìš©ë²•/ìš©ëŸ‰ ë° ê¸°íƒ€ ì¤‘ìš” ì •ë³´(ì˜ˆ: ì œì¡°ì‚¬, ê²½ê³ )ë¥¼ í¬í•¨í•˜ì—¬ í•œêµ­ì–´ë¡œ ìƒì„¸í•˜ê²Œ ì„¤ëª…í•´ ì£¼ì„¸ìš”. ë§Œì•½ ì•½í’ˆ ì´ë¦„ì´ ëª…í™•í•˜ì§€ ì•Šë‹¤ë©´, ë³´ì´ëŠ” ëŒ€ë¡œ ìµœëŒ€í•œ ì¶”ì •í•˜ì—¬ ì •ë³´ë¥¼ ì œê³µí•˜ê³  ê·¸ ì‚¬ì‹¤ì„ ëª…ì‹œí•´ ì£¼ì„¸ìš”. ì •ë³´ë¥¼ ì°¾ì„ ë•ŒëŠ” Google Search grounding ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ì—¬ ì •í™•í•œ ìµœì‹  ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì„¤ëª…í•´ ì£¼ì„¸ìš”.";
                    
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${API_MODEL}:generateContent?key=${apiKey}`;

                    const payload = {
                        contents: [
                            {
                                role: "user",
                                parts: [
                                    { text: userPrompt },
                                    {
                                        inlineData: {
                                            mimeType: image.mimeType,
                                            data: image.base64
                                        }
                                    }
                                ]
                            }
                        ],
                        // ìµœì‹  ì •ë³´ë¥¼ ìœ„í•´ Google Search grounding ì‚¬ìš©
                        tools: [{ "google_search": {} }],
                    };

                    const response = await fetchWithExponentialBackoff(apiUrl, payload);
                    const result = await response.json();
                    
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        let text = candidate.content.parts[0].text;
                        let sources = [];

                        // ì¶œì²˜ ì •ë³´ ì¶”ì¶œ
                        const groundingMetadata = candidate.groundingMetadata;
                        if (groundingMetadata && groundingMetadata.groundingAttributions) {
                            sources = groundingMetadata.groundingAttributions
                                .map(attribution => ({
                                    uri: attribution.web?.uri,
                                    title: attribution.web?.title,
                                }))
                                .filter(source => source.uri && source.title);
                        }

                        // í…ìŠ¤íŠ¸ì— ì¶œì²˜ ì •ë³´ ì¶”ê°€
                        if (sources.length > 0) {
                            text += "\n\n--- ì°¸ì¡° ì¶œì²˜ ---";
                            sources.forEach((source, index) => {
                                text += `\n[${index + 1}] ${source.title} (${source.uri})`;
                            });
                        }

                        // ê²°ê³¼ ì¹´ë“œ ì—…ë°ì´íŠ¸ (ì„±ê³µ)
                        resultCard.innerHTML = `<h3 class="text-xl font-bold text-gemini-green mb-2">âœ… ${i + 1}. ${imageTitle} (ë¶„ì„ ì™„ë£Œ)</h3>
                                                <div class="whitespace-pre-wrap text-gray-700">${text}</div>`;
                        resultCard.className = 'p-6 bg-white border border-gemini-green rounded-lg shadow-xl transition-all';
                        
                    } else {
                        const errorMessage = result.error?.message || "ë¶„ì„ ê²°ê³¼ê°€ ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜ API í˜¸ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                        throw new Error(errorMessage);
                    }

                } catch (error) {
                    console.error(`ì´ë¯¸ì§€ ${imageTitle} ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:`, error);
                    // ê²°ê³¼ ì¹´ë“œ ì—…ë°ì´íŠ¸ (ì˜¤ë¥˜)
                    resultCard.innerHTML = `<h3 class="text-xl font-bold text-red-600 mb-2">âŒ ${i + 1}. ${imageTitle} (ì˜¤ë¥˜ ë°œìƒ)</h3>
                                            <p class="text-red-700">ì˜¤ë¥˜: ì•½í’ˆ ì •ë³´ë¥¼ ë¶„ì„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ${error.message}</p>`;
                    resultCard.className = 'p-6 bg-red-50 border border-red-300 rounded-lg shadow-xl transition-all';
                }
            }

            // ì „ì²´ ë¶„ì„ ì™„ë£Œ í›„ ìµœì¢… ìƒíƒœ ì—…ë°ì´íŠ¸
            showStatus(`ğŸ‰ ëª¨ë“  ì´ë¯¸ì§€(${imageFiles.length}ê°œ) ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');

            // UI ìƒíƒœ ì—…ë°ì´íŠ¸: ë¡œë”© ì¢…ë£Œ
            analyzeButton.disabled = false;
            buttonText.textContent = "ì„ íƒëœ ì•½í’ˆ ì •ë³´ ì¼ê´„ ë¶„ì„ ì‹œì‘";
            loadingSpinner.classList.add('hidden');
        }
    </script>
</body>
</html>
